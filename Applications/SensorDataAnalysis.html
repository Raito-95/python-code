<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sensor Data Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            width: 90%;
            margin: auto;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="charts"></div>

    <script>
        let db;
        const request = indexedDB.open('sensorDatabase', 1);
        const charts = {};
        const sensorDataLength = {}; // Track the length of data for each sensor type

        request.onerror = function(event) {
            console.error('IndexedDB error:', event.target.errorCode);
        };

        request.onsuccess = function(event) {
            db = event.target.result;
            readSensorData();
            setInterval(readSensorData, 1000); // Update every 1 second
        };

        function readSensorData() {
            const transaction = db.transaction(['sensorData'], 'readonly');
            const store = transaction.objectStore('sensorData');
            const getAllRequest = store.getAll();

            getAllRequest.onsuccess = function() {
                const sensorData = getAllRequest.result;
                const sensorTypes = [...new Set(sensorData.map(data => data.type))];
                sensorTypes.forEach(type => {
                    const typeData = sensorData.filter(data => data.type === type);
                    if (!charts[type]) {
                        createChart(typeData, type);
                        sensorDataLength[type] = typeData.length;
                    } else if (sensorDataLength[type] !== typeData.length) {
                        updateChart(typeData, type);
                        sensorDataLength[type] = typeData.length; // Update the recorded data length
                    }
                });
            };
        }

        function createChart(sensorData, sensorType) {
            const container = document.createElement('div');
            container.className = 'chart-container';
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);
            document.getElementById('charts').appendChild(container);

            const chartData = getChartData(sensorData, sensorType);
            const config = {
                type: 'line',
                data: chartData,
                options: {
                    animation: {
                        duration: 0 // Disable animation to prevent chart from redrawing from 0
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            };

            charts[sensorType] = new Chart(canvas, config);
        }

        function updateChart(sensorData, sensorType) {
            const chartData = getChartData(sensorData, sensorType);
            charts[sensorType].data.labels = chartData.labels;
            charts[sensorType].data.datasets.forEach((dataset, index) => {
                dataset.data = chartData.datasets[index].data;
            });
            charts[sensorType].update();
        }

        function getChartData(sensorData, sensorType) {
            const labels = sensorData.map((_, index) => `Sample ${index + 1}`);
            const keys = Object.keys(sensorData[0].data);
            const datasets = keys.map((key, index) => {
                return {
                    label: `${sensorType} ${key.toUpperCase()}`,
                    data: sensorData.map(data => data.data[key]),
                    borderColor: `hsl(${index * 137.508 % 360}, 100%, 50%)`,
                    backgroundColor: `hsla(${index * 137.508 % 360}, 100%, 50%, 0.5)`,
                };
            });

            return { labels, datasets };
        }
    </script>
</body>
</html>
